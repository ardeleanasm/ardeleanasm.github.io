<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />


	<title>First experience with WinApi · Just Computer Engineering</title>


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@mihaiseba" />
<meta name="twitter:title" content="First experience with WinApi" />
<meta name="twitter:description" content="I discovered Linux Api, Linux System Programming some time ago and I found it amazing but I always thought “that’s not enough!”. And it’s not! I have a lot of experience on Linux, I wrote device dr...">

<meta name="description" content="I discovered Linux Api, Linux System Programming some time ago and I found it amazing but I always thought “that’s not enough!”. And it’s not! I have a lot o...">



<link rel="icon" href="/assets/favicon.png">
<link rel="apple-touch-icon" href="/assets/touch-icon.png">
<link rel="stylesheet" href="/assets/core.css">
<link rel="canonical" href="/first-experience-winapi/">
<link rel="alternate" type="application/atom+xml" title="Just Computer Engineering" href="/feed.xml" />




<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54128414-2', 'auto');
  ga('send', 'pageview');

</script>
	</head>

	<body>

		<aside class="logo">

	

	<a href="/">
		<img src="http://www.gravatar.com/avatar/0afb9a47eb6654437c6986283cff151c.png?s=80" class="gravatar">
	</a>
</aside>
<div align="center">
	<a href="/">Home</a>
	<a href="/about">About</a>
	<a href="/articles">Articles</a>
	<a href="https://github.com/ardeleanasm" target="_blank">Projects</a>
	<a href="/archive">Archive</a>
	<a href="/categories">Categories</a>
	<a href="/tags">Tags</a>
    
</div>
<div align="center">
	<p><article><font color="blue">
</font></article></p>
</div>	


		<article>
			<article>

	<div class="center">
		<h1>First experience with WinApi</h1>
		<time>April 24, 2016</time>
	</div>

	<div class="divider"></div>

	<p>I discovered Linux Api, Linux System Programming some time ago and I found it amazing but I always thought “that’s not enough!”. And it’s not! I have a lot of experience 
on Linux, I wrote device drivers, userspace applications using C and Linux API but I never tried to wrote some applications that use Windows API.</p>

<p>This post will be the first about my experience with WinApi, system calls etc. I’m getting really tired to write apps on Windows in C++ CLR or C# and I 
want to try something more “low level”. Note, all my small projects using WinApi will be integrated in Git under <a href="https://github.com/ardeleanasm/projects/tree/master/winapi/RegistryList">projects/winapi</a>.</p>

<p>Now, I should talk about the first small project, not done yet. RegistryList will be an application that will dump all Registry Entries&lt;Key,Value&gt; and will
allow user to set some filters, also maybe to clean/fix Registry Entries and extract and save data from entries. Maybe, in the last iteration, I’ll add some 
UI to application and maybe I’ll maintain it. But now, the application is just a bunch of C++ classes and can only dump Registry Entries&lt;Key, Value&gt; and print
them. It’s not so nice…</p>

<p>Code…. hmmm, code can be found <a href="https://github.com/ardeleanasm/projects/tree/master/winapi/RegistryList">HERE</a> but, let’s talk a little.</p>

<p>I wrote a lot of C code and I don’t really like return codes, if I can throw an exception. OK, on Linux, where I try to wrote all the applications in C code, 
I need to use return codes, but if I use WinApi and C++… Why not use exceptions?</p>

<p>So, in <strong>KeyQueryExceptions.h</strong> I defined some custom exceptions for the case where some parameters are not set or the some call to WinApi function return an error that
is not <em>ERROR_SUCCESS</em> ( I really found this name funny, ERROR_SUCCESS… It’s a success or failure? :) ).</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CRegOpenKeyExException</span> <span class="o">:</span><span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span>
<span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">g_msg</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CRegOpenKeyExException</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">:</span><span class="n">g_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
	<span class="p">{}</span>

	<span class="n">CRegOpenKeyExException</span><span class="p">()</span> <span class="o">:</span><span class="n">g_msg</span><span class="p">(</span><span class="s">"RegOpenKeyEx call failed!"</span><span class="p">){}</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ShowReason</span><span class="p">()</span> <span class="k">const</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">g_msg</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="p">}</span>


<span class="p">};</span>
</code></pre></div></div>

<p>In the code snippet is defined an exception that is thrown when RegOpenKeyExt function call return a value different from ERROR_SUCCESS.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#pragma once
</span>

<span class="k">class</span> <span class="nc">CKeyQuery</span>
<span class="p">{</span>
	<span class="n">CKeyQuery</span><span class="p">(</span><span class="n">CKeyQuery</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
	<span class="n">CKeyQuery</span><span class="p">(</span><span class="n">CKeyQuery</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
	<span class="n">CKeyQuery</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">CKeyQuery</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
	<span class="n">CKeyQuery</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">CKeyQuery</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CKeyQuery</span><span class="p">();</span>
	<span class="o">~</span><span class="n">CKeyQuery</span><span class="p">();</span>
	<span class="kt">void</span> <span class="n">QueryKey</span><span class="p">(</span><span class="n">HKEY</span> <span class="n">hKey</span><span class="p">,</span> <span class="n">UINT32</span> <span class="o">*</span> <span class="n">subKeys</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">RegistryOpenKey</span><span class="p">(</span><span class="n">_Out_</span> <span class="n">PHKEY</span> <span class="n">phkResult</span><span class="p">)</span> <span class="k">throw</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">SethKey</span><span class="p">(</span><span class="n">HKEY</span> <span class="n">hkey</span><span class="p">);</span>
	<span class="kt">void</span>  <span class="n">SetSubKey</span><span class="p">(</span><span class="n">LPCTSTR</span> <span class="n">lpSubKey</span><span class="p">);</span>
	<span class="kt">void</span>  <span class="n">SetulOptions</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">ulOptions</span><span class="p">);</span>
	<span class="kt">void</span>  <span class="n">SetSamdesired</span><span class="p">(</span><span class="n">REGSAM</span> <span class="n">samDesired</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">RegistryClose</span><span class="p">(</span><span class="n">_In_</span> <span class="n">HKEY</span> <span class="n">hKey</span><span class="p">);</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">HKEY</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">HKEY</span> <span class="n">g_hkey</span><span class="p">;</span>
	<span class="n">LPCTSTR</span> <span class="n">g_lpSubKey</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">g_ulOptions</span><span class="p">;</span>
	<span class="n">REGSAM</span> <span class="n">g_samDesired</span><span class="p">;</span>
	

<span class="p">};</span>
</code></pre></div></div>

<p>The above code define a class CKeyQuery. The set methods are used to set the values that will be used as parameters to RegOpenKeyEx function. The constructor and
destructor of this class are used only for setting some default values, for now.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CKeyQuery</span><span class="o">::</span><span class="n">CKeyQuery</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">g_hkey</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
	<span class="n">g_lpSubKey</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
	<span class="n">g_ulOptions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">g_samDesired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">CKeyQuery</span><span class="o">::~</span><span class="n">CKeyQuery</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">g_hkey</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
	<span class="n">g_lpSubKey</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
	<span class="n">g_ulOptions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">g_samDesired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The methods SethKey, SetSubKey,SetulOptions and SetSamdesired are simple one-line methods that will only set the values.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">CKeyQuery</span><span class="o">::</span><span class="n">RegistryOpenKey</span><span class="p">(</span><span class="n">_Out_</span> <span class="n">PHKEY</span> <span class="n">phkResult</span><span class="p">)</span> <span class="k">throw</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g_hkey</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">CParametersNotSetException</span><span class="p">(</span><span class="s">"hkey parameter was not set"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g_lpSubKey</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">){</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">CParametersNotSetException</span><span class="p">(</span><span class="s">"lpSubKey was not set!"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RegOpenKeyEx</span><span class="p">(</span><span class="n">g_hkey</span><span class="p">,</span> <span class="n">g_lpSubKey</span><span class="p">,</span> <span class="n">g_ulOptions</span><span class="p">,</span> <span class="n">g_samDesired</span><span class="p">,</span> <span class="n">phkResult</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ERROR_SUCCESS</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">CRegOpenKeyExException</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>RegistryOpenKey is a wrapper on RegOpenKeyEx system call. Here, I only test if hkey and lpSubKey are not nullptr( are not default values) and call RegOpenKeyEx. 
Here is where I used the exceptions, cause I don’t like returning error codes. :)</p>

<p>And now, surprise, I won’t describe the most important method, <code class="highlighter-rouge">void CKeyQuery::QueryKey(HKEY hKey, UINT32 *subKeys)</code>. Why? Because the most part of it 
was took from <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724256(v=vs.85).aspx">Microsoft</a>. When the application will be more complex and this
function will not be “copy-paste” entirely I’ll come with another article describing the modifications that I done.</p>

<p>Conclusions? 
Hmmm, I’m really impressed until now. I searched and found a book about <a href="http://www.amazon.com/Windows-Programming-Addison-Wesley-Microsoft-Technology/dp/0321657748">Windows System Programming</a>
and I start to read it. I really like, even if the Hungarian notation conventions adopded by Microsoft maybe seems strange ( trust me, I saw notations even stranger).
I’m really curious what I’ll can do, maybe I’ll start also to read more about drivers ( even if I participated at a course about Windows Device Drivers, I 
never wrote one by myself, I just copy-pasted some code).</p>



	
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = '23ars';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

<div class="page-navigation">
	
    <a class="next" href="/deutschs-algorithm/" title="NEXT: Deutsch's Algorithm">&lt;&lt;</a>
		<span> &middot; </span>
  
		<a class="home" href="/" title="Back to Homepage">Home</a>
  
</div>

		</article>>

		<div class="footer">
  <div align="center">
  <link rel="stylesheet" href="/assets/core.css">





<a href="https://github.com/ardeleanasm"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/ardelean-sebastian-mihai"><i class="svg-icon linkedin"></i></a>

<a href="/feed.xml"><i class="svg-icon rss"></i></a>
<a href="https://www.twitter.com/mihaiseba"><i class="svg-icon twitter"></i></a>
<a href="http://stackoverflow.com/users/1462225/23ars"><i class="svg-icon stackoverflow"></i></a>

  
  </div>
  <span class="block">&copy; 2019 Mihai Seba</span>
</div>


	</body>

</html>
