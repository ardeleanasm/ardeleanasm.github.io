<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>First experience with WinApi</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../css/blogstyle.css" />
</head>
<body>
<div class="header"> <a href="../blog.html">&larr; Posts</a> </div>
<header>
<h1 class="title">First experience with WinApi</h1>
</header>
<div class="header">
<a href="../blog.html">← Posts</a>
</div>
<div class="header">
<a href="../blog.html">← Posts</a>
</div>
<p>I discovered Linux Api, Linux System Programming some time ago and I found it amazing but I always thought “that’s not enough!”. And it’s not! I have a lot of experience on Linux, I wrote device drivers, userspace applications using C and Linux API but I never tried to wrote some applications that use Windows API.</p>
<p>This post will be the first about my experience with WinApi, system calls etc. I’m getting really tired to write apps on Windows in C++ CLR or C# and I want to try something more “low level”. Note, all my small projects using WinApi will be integrated in Git under <a href="https://github.com/ardeleanasm/projects/tree/master/winapi/RegistryList">projects/winapi</a>.</p>
<p>Now, I should talk about the first small project, not done yet. RegistryList will be an application that will dump all Registry Entries&lt;Key,Value&gt; and will allow user to set some filters, also maybe to clean/fix Registry Entries and extract and save data from entries. Maybe, in the last iteration, I’ll add some UI to application and maybe I’ll maintain it. But now, the application is just a bunch of C++ classes and can only dump Registry Entries&lt;Key, Value&gt; and print them. It’s not so nice…</p>
<p>Code…. hmmm, code can be found <a href="https://github.com/ardeleanasm/projects/tree/master/winapi/RegistryList">HERE</a> but, let’s talk a little.</p>
<p>I wrote a lot of C code and I don’t really like return codes, if I can throw an exception. OK, on Linux, where I try to wrote all the applications in C code, I need to use return codes, but if I use WinApi and C++… Why not use exceptions?</p>
<p>So, in <strong>KeyQueryExceptions.h</strong> I defined some custom exceptions for the case where some parameters are not set or the some call to WinApi function return an error that is not <em>ERROR_SUCCESS</em> ( I really found this name funny, ERROR_SUCCESS… It’s a success or failure? :) ).</p>
<div id="cb1" class="sourceCode">
<div id="cb1" class="sourceCode">
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">class</span> CRegOpenKeyExException :<span class="kw">public</span> <span class="bu">std::</span>exception</a>
<a class="sourceLine" id="cb1-2" title="2">{</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb1-4" title="4">    <span class="bu">std::</span>string <span class="va">g_msg</span>;</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb1-6" title="6">    CRegOpenKeyExException(<span class="at">const</span> <span class="bu">std::</span>string&amp; msg) :<span class="va">g_msg</span>(msg)</a>
<a class="sourceLine" id="cb1-7" title="7">    {}</a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9">    CRegOpenKeyExException() :<span class="va">g_msg</span>(<span class="st">&quot;RegOpenKeyEx call failed!&quot;</span>){}</a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="at">const</span> <span class="dt">char</span> *ShowReason() <span class="at">const</span></a>
<a class="sourceLine" id="cb1-11" title="11">    {</a>
<a class="sourceLine" id="cb1-12" title="12">        <span class="cf">return</span> <span class="va">g_msg</span>.c_str();</a>
<a class="sourceLine" id="cb1-13" title="13">    }</a>
<a class="sourceLine" id="cb1-14" title="14"></a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16">};</a></code></pre></div>
</div>
</div>
<p>In the code snippet is defined an exception that is thrown when RegOpenKeyExt function call return a value different from ERROR_SUCCESS.</p>
<div id="cb2" class="sourceCode">
<div id="cb2" class="sourceCode">
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb2-1" title="1"><span class="pp">#pragma once</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">class</span> CKeyQuery</a>
<a class="sourceLine" id="cb2-5" title="5">{</a>
<a class="sourceLine" id="cb2-6" title="6">    CKeyQuery(CKeyQuery <span class="at">const</span> &amp;) = <span class="kw">delete</span>;</a>
<a class="sourceLine" id="cb2-7" title="7">    CKeyQuery(CKeyQuery &amp;&amp;) = <span class="kw">delete</span>;</a>
<a class="sourceLine" id="cb2-8" title="8">    CKeyQuery &amp;<span class="kw">operator</span>=(CKeyQuery <span class="at">const</span> &amp;) = <span class="kw">delete</span>;</a>
<a class="sourceLine" id="cb2-9" title="9">    CKeyQuery &amp;<span class="kw">operator</span>=(CKeyQuery &amp;&amp;) = <span class="kw">delete</span>;</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb2-11" title="11">    CKeyQuery();</a>
<a class="sourceLine" id="cb2-12" title="12">    ~CKeyQuery();</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="dt">void</span> QueryKey(HKEY hKey, UINT32 * subKeys);</a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="dt">void</span> RegistryOpenKey(_Out_ PHKEY phkResult) <span class="cf">throw</span> (<span class="bu">std::</span>exception);</a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="dt">void</span> SethKey(HKEY hkey);</a>
<a class="sourceLine" id="cb2-16" title="16">    <span class="dt">void</span>  SetSubKey(LPCTSTR lpSubKey);</a>
<a class="sourceLine" id="cb2-17" title="17">    <span class="dt">void</span>  SetulOptions(DWORD ulOptions);</a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="dt">void</span>  SetSamdesired(REGSAM samDesired);</a>
<a class="sourceLine" id="cb2-19" title="19">    <span class="dt">void</span> RegistryClose(_In_ HKEY hKey);</a>
<a class="sourceLine" id="cb2-20" title="20"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb2-21" title="21">    HKEY key;</a>
<a class="sourceLine" id="cb2-22" title="22">    HKEY <span class="va">g_hkey</span>;</a>
<a class="sourceLine" id="cb2-23" title="23">    LPCTSTR <span class="va">g_lpSubKey</span>;</a>
<a class="sourceLine" id="cb2-24" title="24">    DWORD <span class="va">g_ulOptions</span>;</a>
<a class="sourceLine" id="cb2-25" title="25">    REGSAM <span class="va">g_samDesired</span>;</a>
<a class="sourceLine" id="cb2-26" title="26">    </a>
<a class="sourceLine" id="cb2-27" title="27"></a>
<a class="sourceLine" id="cb2-28" title="28">};</a></code></pre></div>
</div>
</div>
<p>The above code define a class CKeyQuery. The set methods are used to set the values that will be used as parameters to RegOpenKeyEx function. The constructor and destructor of this class are used only for setting some default values, for now.</p>
<div id="cb3" class="sourceCode">
<div id="cb3" class="sourceCode">
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1">CKeyQuery::CKeyQuery()</a>
<a class="sourceLine" id="cb3-2" title="2">{</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="va">g_hkey</span> = <span class="kw">nullptr</span>;</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="va">g_lpSubKey</span> = <span class="kw">nullptr</span>;</a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="va">g_ulOptions</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="va">g_samDesired</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-7" title="7">}</a>
<a class="sourceLine" id="cb3-8" title="8">CKeyQuery::~CKeyQuery()</a>
<a class="sourceLine" id="cb3-9" title="9">{</a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="va">g_hkey</span> = <span class="kw">nullptr</span>;</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="va">g_lpSubKey</span> = <span class="kw">nullptr</span>;</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="va">g_ulOptions</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="va">g_samDesired</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb3-14" title="14">}</a></code></pre></div>
</div>
</div>
<p>The methods SethKey, SetSubKey,SetulOptions and SetSamdesired are simple one-line methods that will only set the values.</p>
<div id="cb4" class="sourceCode">
<div id="cb4" class="sourceCode">
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb4-1" title="1"><span class="dt">void</span> CKeyQuery::RegistryOpenKey(_Out_ PHKEY phkResult) <span class="cf">throw</span> (<span class="bu">std::</span>exception)</a>
<a class="sourceLine" id="cb4-2" title="2">{</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="cf">if</span> (<span class="va">g_hkey</span> == <span class="kw">nullptr</span>)</a>
<a class="sourceLine" id="cb4-4" title="4">    {</a>
<a class="sourceLine" id="cb4-5" title="5">        <span class="cf">throw</span> <span class="kw">new</span> CParametersNotSetException(<span class="st">&quot;hkey parameter was not set&quot;</span>);</a>
<a class="sourceLine" id="cb4-6" title="6">    }</a>
<a class="sourceLine" id="cb4-7" title="7">    <span class="cf">if</span> (<span class="va">g_lpSubKey</span> == <span class="kw">nullptr</span>){</a>
<a class="sourceLine" id="cb4-8" title="8">        <span class="cf">throw</span> <span class="kw">new</span> CParametersNotSetException(<span class="st">&quot;lpSubKey was not set!&quot;</span>);</a>
<a class="sourceLine" id="cb4-9" title="9">    }</a>
<a class="sourceLine" id="cb4-10" title="10">    <span class="cf">if</span> (RegOpenKeyEx(<span class="va">g_hkey</span>, <span class="va">g_lpSubKey</span>, <span class="va">g_ulOptions</span>, <span class="va">g_samDesired</span>, phkResult) != ERROR_SUCCESS)</a>
<a class="sourceLine" id="cb4-11" title="11">    {</a>
<a class="sourceLine" id="cb4-12" title="12">        <span class="cf">throw</span> <span class="kw">new</span> CRegOpenKeyExException();</a>
<a class="sourceLine" id="cb4-13" title="13">    }</a>
<a class="sourceLine" id="cb4-14" title="14">}</a></code></pre></div>
</div>
</div>
<p>RegistryOpenKey is a wrapper on RegOpenKeyEx system call. Here, I only test if hkey and lpSubKey are not nullptr( are not default values) and call RegOpenKeyEx. Here is where I used the exceptions, cause I don’t like returning error codes. :)</p>
<p>And now, surprise, I won’t describe the most important method, <code>void CKeyQuery::QueryKey(HKEY hKey, UINT32 *subKeys)</code>. Why? Because the most part of it was took from <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724256(v=vs.85).aspx">Microsoft</a>. When the application will be more complex and this function will not be “copy-paste” entirely I’ll come with another article describing the modifications that I done.</p>
<p>Conclusions? Hmmm, I’m really impressed until now. I searched and found a book about <a href="http://www.amazon.com/Windows-Programming-Addison-Wesley-Microsoft-Technology/dp/0321657748">Windows System Programming</a> and I start to read it. I really like, even if the Hungarian notation conventions adopded by Microsoft maybe seems strange ( trust me, I saw notations even stranger). I’m really curious what I’ll can do, maybe I’ll start also to read more about drivers ( even if I participated at a course about Windows Device Drivers, I never wrote one by myself, I just copy-pasted some code).</p>
<div class="header">
<a href="../blog.html">← Posts</a>
</div>
<div class="header">
<a href="../blog.html">← Posts</a>
</div>
<div class="header"> <a href="../blog.html">&larr; Posts</a> </div>
</body>
</html>
